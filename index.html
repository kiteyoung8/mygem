<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>anyGem v53.2 : The Ultimate Consultant</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --bg-dark: #020617; --bg-panel: #1e293b; --accent: #10b981; --text: #e2e8f0; }
        body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-dark); color: var(--text); overflow: hidden; display: flex; height: 100vh; width: 100vw; }
        
        #sidebar { width: 260px; background-color: #0f172a; border-right: 1px solid #1e293b; display: flex; flex-direction: column; z-index: 50; transition: transform 0.3s; }
        @media (max-width: 768px) { #sidebar { position: fixed; height: 100%; transform: translateX(-100%); } #sidebar.open { transform: translateX(0); } }
        
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; height: 100%; width: 100%; }
        .glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.05); padding: 15px; }
        
        .btn-primary { background-color: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.2s; display: flex; align-items: center; gap: 8px; justify-content: center; }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-primary:disabled { opacity: 0.5; cursor: wait; }
        
        select, input[type="text"], input[type="number"], textarea { background: #334155; color: white; border: 1px solid #475569; padding: 8px; border-radius: 6px; outline: none; width: 100%; box-sizing: border-box; }
        select:focus, input:focus, textarea:focus { border-color: var(--accent); }
        
        #top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #search-options, #ppt-panel { background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 12px; padding: 15px; margin-top: 10px; display: none; }
        #search-options.active, #ppt-panel.active { display: block; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; padding-bottom: 80px; }
        .msg-row { display: flex; margin-bottom: 20px; }
        .msg-row.user { justify-content: flex-end; }
        .msg-bubble { max-width: 80%; padding: 15px; border-radius: 12px; line-height: 1.6; font-size: 14px; position: relative; word-wrap: break-word; }
        .msg-row.user .msg-bubble { background-color: #047857; color: white; border-top-right-radius: 2px; }
        .msg-row.ai .msg-bubble { background-color: var(--bg-panel); border: 1px solid #334155; border-top-left-radius: 2px; }
        .msg-bubble img { max-width: 100%; border-radius: 8px; margin-top: 10px; }
        
        /* è¤‡è£½æŒ‰éˆ•æ¨£å¼ */
        .copy-btn { margin-top: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #94a3b8; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 5px; float: right; transition: all 0.2s; }
        .copy-btn:hover { background: rgba(16, 185, 129, 0.2); color: var(--accent); border-color: var(--accent); }
        
        footer { padding: 15px; background: rgba(2, 6, 23, 0.95); border-top: 1px solid #1e293b; position: absolute; bottom: 0; width: 100%; display: flex; gap: 10px; align-items: flex-end; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        @media (max-width: 640px) { .grid-2, .grid-4 { grid-template-columns: 1fr; } }
        
        .loader { text-align: center; color: var(--accent); font-size: 12px; font-weight: bold; margin: 10px 0; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .history-item { padding: 10px; cursor: pointer; border-radius: 6px; font-size: 13px; color: #94a3b8; display: flex; justify-content: space-between; margin-bottom: 2px; }
        .history-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .history-item.active { background: rgba(16, 185, 129, 0.2); color: var(--accent); border: 1px solid rgba(16, 185, 129, 0.2); }
    </style>
</head>
<body>

    <aside id="sidebar">
        <div style="padding: 20px; border-bottom: 1px solid #1e293b;">
            <button onclick="newChat()" class="btn-primary" style="width: 100%;">
                <i class="fas fa-plus"></i> æ–°å¢å°è©±
            </button>
        </div>
        <div id="history-list" style="flex: 1; overflow-y: auto; padding: 10px;">
            <div style="text-align: center; font-size: 12px; color: #64748b; margin-top: 20px;">è¼‰å…¥ç´€éŒ„ä¸­...</div>
        </div>
        <div style="padding: 15px; text-align: center; font-size: 10px; color: #475569; border-top: 1px solid #1e293b;">
            ANYGEM V53.2
        </div>
    </aside>

    <div id="overlay" onclick="toggleSidebar()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:40;display:none;"></div>

    <div class="main-content">
        <header class="glass">
            <div id="top-bar">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:18px; cursor:pointer;" class="md:hidden"><i class="fas fa-bars"></i></button>
                    <span style="font-weight:900; font-style:italic; font-size:18px;">anyGem <span style="color:var(--accent); font-size:12px;">v53.2</span></span>
                </div>
                <select id="mode-select" onchange="updateUI()" style="width: auto; font-size: 12px; font-weight: bold;">
                    <option value="chat">ğŸ’¬ æ™ºèƒ½åŠ©ç†</option>
                    <option value="search">ğŸŒ æ·±åº¦ç ”ç©¶ (é¡§å•æ¨¡å¼)</option>
                    <option value="presentation">ğŸ“Š æ™ºèƒ½ç°¡å ± (Gamma æ¨¡å¼)</option>
                    <option value="drawing">ğŸ¨ è—è¡“ç”Ÿåœ–</option>
                </select>
            </div>

            <div id="search-options">
                <div class="grid-2" style="margin-bottom: 10px;">
                    <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" id="create-report-check" checked style="width:16px; height:16px;">
                        <label for="create-report-check" style="font-size:12px; cursor:pointer;">ğŸ“ ç”Ÿæˆå°ˆæ¥­ç ”å ± (Doc)</label>
                    </div>
                    <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" id="create-ppt-check" style="width:16px; height:16px;">
                        <label for="create-ppt-check" style="font-size:12px; cursor:pointer;">ğŸ“Š ç”Ÿæˆæ™ºèƒ½ç°¡å ± (Slides)</label>
                    </div>
                </div>
                <div class="grid-2">
                    <div>
                        <label style="font-size:9px; color:#10b981; font-weight:bold; display:block; margin-bottom:4px;">é¢¨æ ¼æŒ‡ä»¤</label>
                        <input type="text" id="consult-style" placeholder="å¦‚: ç§‘æŠ€è—, æº«æš–æ©˜...">
                    </div>
                    <div>
                        <label style="font-size:9px; color:#10b981; font-weight:bold; display:block; margin-bottom:4px;">é è¨ˆé æ•¸</label>
                        <input type="number" id="consult-length" value="6">
                    </div>
                </div>
            </div>

            <div id="ppt-panel">
                <div class="grid-4">
                    <div>
                        <label style="font-size:9px; color:#10b981; font-weight:bold; display:block; margin-bottom:4px;">é æ•¸</label>
                        <input type="number" id="ppt-length" value="6" min="3" max="20">
                    </div>
                    <div>
                        <label style="font-size:9px; color:#10b981; font-weight:bold; display:block; margin-bottom:4px;">æ·±åº¦</label>
                        <select id="ppt-density"><option value="detailed">ğŸ“š è©³ç´°è§£èªª</option><option value="brief">âš¡ ç²¾ç°¡å¤§ç¶±</option></select>
                    </div>
                    <div>
                        <label style="font-size:9px; color:#10b981; font-weight:bold; display:block; margin-bottom:4px;">ä¸»é¡Œ</label>
                        <select id="ppt-theme">
                            <option value="modern_blue">ğŸ”µ ç§‘æŠ€æ·±è—</option>
                            <option value="warm_orange">ğŸŸ  æº«æš–æ´»åŠ›</option>
                            <option value="forest_green">ğŸŸ¢ æ°¸çºŒæ£®æ—</option>
                            <option value="dark_cyber">âš« æš—é»‘æ¨¡å¼</option>
                        </select>
                    </div>
                    <div style="display:flex; align-items:flex-end;">
                        <div style="background:#0f172a; padding:8px; border-radius:6px; display:flex; align-items:center; gap:8px; width:100%; height: 35px;">
                            <input type="checkbox" id="ppt-ai-img" checked style="width:14px; height:14px;">
                            <label for="ppt-ai-img" style="font-size:11px;">AI é…åœ–</label>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main id="chat-window">
            <div class="msg-row ai">
                <div class="msg-bubble">
                    ğŸ‘‹ å—¨ï¼æˆ‘æ˜¯ <b>anyGem v53.2</b>ã€‚<br>
                    åŠŸèƒ½é¸å–®å·²æº–å‚™å°±ç·’ï¼š<br>
                    ğŸŒ <b>æ·±åº¦ç ”ç©¶</b>ï¼šå°ˆæ¥­é¡§å•å¼•å° + Doc/Slides é›™ç”¢å‡ºã€‚<br>
                    ğŸ“Š <b>æ™ºèƒ½ç°¡å ±</b>ï¼šå¿«é€Ÿç”Ÿæˆ Gamma é¢¨æ ¼ç°¡å ±ã€‚<br>
                    ğŸ¨ <b>è—è¡“ç”Ÿåœ–</b>ï¼šé«˜å“è³ª AI ç¹ªåœ–ã€‚<br>
                    <i>(è¤‡è£½åŠŸèƒ½å·²ä¿®å¾© âœ¨)</i>
                </div>
            </div>
        </main>

        <div id="file-preview-bar" style="display:none; position:absolute; bottom:90px; left:20px; right:20px; background:#1e293b; padding:10px; border-radius:10px; border:1px solid #10b981; align-items:center; justify-content:space-between;">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="width:30px; height:30px; background:#0f172a; display:flex; justify-content:center; align-items:center; border-radius:5px;"><i class="fas fa-file text-emerald-500"></i></div>
                <div style="display:flex; flex-direction:column;">
                    <span id="file-name-label" style="font-size:12px; font-weight:bold;">File Ready</span>
                    <span style="font-size:9px; color:#10b981;">Ready to analyze</span>
                </div>
            </div>
            <button onclick="clearFile()" style="background:none; border:none; color:#94a3b8; cursor:pointer;">âœ•</button>
        </div>

        <footer>
            <input type="file" id="file-input" style="display:none;">
            <button onclick="document.getElementById('file-input').click()" style="background:#1e293b; border:1px solid #334155; color:#10b981; width:50px; height:50px; border-radius:10px; cursor:pointer;">
                <i class="fas fa-paperclip" style="font-size:18px;"></i>
            </button>
            <div style="flex:1;">
                <textarea id="user-input" rows="1" placeholder="è¼¸å…¥è¨Šæ¯..." style="width:100%; height:50px; padding:12px; resize:none;"></textarea>
            </div>
            <button onclick="handleSend()" id="send-btn" class="btn-primary" style="height:50px; padding:0 25px;">
                SEND <i class="fas fa-paper-plane"></i>
            </button>
        </footer>
    </div>

    <script>
        // âš ï¸âš ï¸âš ï¸ è«‹å‹™å¿…ç¢ºèªæ­¤ç¶²å€æ˜¯æ‚¨æœ€æ–°éƒ¨ç½²çš„ Web App URL âš ï¸âš ï¸âš ï¸
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwsng4RBCTX67my46U4fv7BhDYT0CIZt95dL7DNCFJTGUJLZFd_854vRGeUsQ1_BjG9/exec"; 
        
        let sessId = localStorage.getItem('ANYGEM_USER_ID') || "UID_" + Date.now();
        localStorage.setItem('ANYGEM_USER_ID', sessId);

        const chatWindow = document.getElementById('chat-window'), input = document.getElementById('user-input'), btn = document.getElementById('send-btn'), modeSelect = document.getElementById('mode-select'), searchOptions = document.getElementById('search-options'), pptPanel = document.getElementById('ppt-panel'), previewBar = document.getElementById('file-preview-bar');
        let activeFile = null;

        function updateUI() {
            const m = modeSelect.value;
            searchOptions.className = m === 'search' ? 'active' : '';
            pptPanel.className = m === 'presentation' ? 'active' : '';
            if (m === 'search') input.placeholder = "è¼¸å…¥ä¸»é¡Œï¼Œé¡§å• PM å°‡å¼•å°æ‚¨...";
            else if (m === 'presentation') input.placeholder = "è²¼ä¸Šæ–‡ç« ï¼Œç”Ÿæˆç°¡å ±...";
            else if (m === 'drawing') input.placeholder = "è¼¸å…¥æè¿°æˆ–ä¸Šå‚³è‰åœ–...";
            else input.placeholder = "è¼¸å…¥è¨Šæ¯...";
            input.focus();
        }

        async function handleSend() {
            const text = input.value.trim(); if(!text && !activeFile) return;
            addMessage('user', text, { fileName: activeFile?.name });

            const payload = { message: text, session_id: sessId, mode: modeSelect.value, options: {} };
            
            if (payload.mode === 'search') {
                payload.options = { 
                    create_report: document.getElementById('create-report-check').checked, 
                    create_ppt: document.getElementById('create-ppt-check').checked, 
                    style: document.getElementById('consult-style').value, 
                    length: document.getElementById('consult-length').value 
                };
            } else if (payload.mode === 'presentation') {
                payload.options = { 
                    length: document.getElementById('ppt-length').value, 
                    density: document.getElementById('ppt-density').value, 
                    theme: document.getElementById('ppt-theme').value, 
                    use_ai_image: document.getElementById('ppt-ai-img').checked 
                };
            }

            const tempFile = activeFile; input.value = ''; clearFile();
            if(tempFile) { 
                setLoading(true, "Uploading..."); 
                const base64 = await toBase64(tempFile); 
                payload.file_data = base64.split(',')[1]; 
                payload.mime_type = tempFile.type; 
            }

            let loadTxt = "AI Working...";
            if (payload.mode === 'search') loadTxt = "Consulting...";
            if (payload.mode === 'presentation') loadTxt = "Generating...";
            if (payload.mode === 'drawing') loadTxt = "Painting...";
            setLoading(true, loadTxt);

            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                const data = await res.json();
                if(data.status === "success") { 
                    addMessage('ai', data.reply, { model: data.model, image: data.image, mime: data.mime }); 
                    fetchHistoryList(); 
                } else { 
                    addMessage('ai', "ğŸš¨ Error: " + (data.error || "Unknown Error")); 
                }
            } catch (e) { 
                addMessage('ai', "âŒ é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥éƒ¨ç½²ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚"); 
            } finally { 
                setLoading(false); 
            }
        }

        function addMessage(role, text, meta = null) {
            const row = document.createElement('div');
            row.className = `msg-row ${role}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'msg-bubble';
            
            if(meta?.fileName) bubble.innerHTML += `<div style="font-size:11px; margin-bottom:5px; opacity:0.8;"><i class="fas fa-file"></i> ${meta.fileName}</div>`;
            if(meta?.image) bubble.innerHTML += `<img src="data:${meta.mime || 'image/png'};base64,${meta.image}">`;
            
            if(window.marked) bubble.innerHTML += marked.parse(text || "");
            else bubble.innerText += text; 
            
            // âš ï¸ é€™è£¡å°±æ˜¯è£œå›çš„è¤‡è£½æŒ‰éˆ•é‚è¼¯ âš ï¸
            if (role === 'ai') {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.innerHTML = '<i class="fas fa-copy"></i> è¤‡è£½å…§å®¹';
                copyBtn.onclick = () => {
                    // ç§»é™¤ HTML æ¨™ç±¤åªè¤‡è£½ç´”æ–‡å­— (æˆ–è€…æ‚¨å¯ä»¥é¸æ“‡è¤‡è£½åŒ…å«æ ¼å¼çš„)
                    const plainText = text; 
                    navigator.clipboard.writeText(plainText).then(() => {
                        copyBtn.innerHTML = '<i class="fas fa-check"></i> å·²è¤‡è£½';
                        setTimeout(() => copyBtn.innerHTML = '<i class="fas fa-copy"></i> è¤‡è£½å…§å®¹', 2000);
                    });
                };
                bubble.appendChild(copyBtn);
            }

            row.appendChild(bubble);
            chatWindow.appendChild(row);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        document.getElementById('file-input').onchange = (e) => {
            activeFile = e.target.files[0]; if(!activeFile) return;
            previewBar.style.display = 'flex';
            document.getElementById('file-name-label').innerText = activeFile.name;
        };

        function toggleSidebar() { 
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            if(sb.style.transform === 'translateX(0px)') {
                sb.style.transform = ''; overlay.style.display = 'none';
            } else {
                sb.style.transform = 'translateX(0px)'; overlay.style.display = 'block';
            }
        }
        function newChat() { sessId = "UID_" + Date.now(); localStorage.setItem('ANYGEM_USER_ID', sessId); chatWindow.innerHTML = ''; fetchHistoryList(); }
        
        async function fetchHistoryList() {
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ mode: 'system', action: 'get_session_list' }) });
                const data = await res.json();
                const list = document.getElementById('history-list'); list.innerHTML = '';
                if(data.sessions && data.sessions.length > 0) {
                    data.sessions.forEach(s => {
                        const d = document.createElement('div');
                        d.className = `history-item ${s.id === sessId ? 'active' : ''}`;
                        d.innerHTML = `<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:180px;">${s.title}</span><i class="fas fa-trash" onclick="deleteChat('${s.id}')"></i>`;
                        d.onclick = (e) => { if(e.target.tagName !== 'I') loadSession(s.id); };
                        list.appendChild(d);
                    });
                } else { list.innerHTML = '<div style="text-align:center;font-size:12px;color:#64748b;margin-top:10px;">å°šç„¡ç´€éŒ„</div>'; }
            } catch(e){}
        }
        
        async function loadSession(id) { sessId = id; chatWindow.innerHTML = '<div class="loader">Loading...</div>'; const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ mode: 'system', action: 'load_session', session_id: id }) }); const data = await res.json(); chatWindow.innerHTML=''; data.logs.forEach(l => addMessage(l.role, l.text)); }
        async function deleteChat(id) { if(confirm("åˆªé™¤æ­¤å°è©±ï¼Ÿ")) { await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ mode: 'system', action: 'delete_session', session_id: id }) }); fetchHistoryList(); } }
        function clearFile() { activeFile = null; previewBar.style.display = 'none'; document.getElementById('file-input').value = ''; }
        function toBase64(f) { return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(f); }); }
        
        function setLoading(isLoading, text) {
            btn.disabled = isLoading;
            if(isLoading) {
                const d = document.createElement('div'); d.id = 'loader'; d.className = 'loader';
                d.innerHTML = `<i class="fas fa-bolt"></i> ${text.toUpperCase()}`;
                chatWindow.appendChild(d); chatWindow.scrollTop = chatWindow.scrollHeight;
            } else { document.getElementById('loader')?.remove(); }
        }
        
        updateUI(); fetchHistoryList();
    </script>
</body>
</html>
