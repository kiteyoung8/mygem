<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>anyGem v60.3 Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              background: '#0f172a',
              surface: '#1e293b',
              primary: '#10b981',
              accent: '#34d399',
            },
            animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
            keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
          }
        }
      }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    
    <style>
      /* Ëá™ÂÆöÁæ©Êç≤Ëª∏ */
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }
      body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif; overflow: hidden; }
      
      /* Markdown ÂÖßÂÆπÊ®£Âºè */
      .markdown-body img { max-width: 100%; border-radius: 8px; margin: 10px 0; border: 1px solid #334155; }
      .markdown-body pre { background: #0f172a; padding: 12px; border-radius: 6px; overflow-x: auto; margin: 10px 0; border: 1px solid #334155; }
      .markdown-body code { font-family: monospace; background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 3px; color: #e2e8f0; font-size: 0.9em; }
      .markdown-body pre code { background: transparent; padding: 0; color: #a5b4fc; }
      .markdown-body a { color: #34d399; text-decoration: none; border-bottom: 1px dashed #34d399; }
      .markdown-body a:hover { border-bottom-style: solid; }
      .markdown-body ul { list-style-type: disc; padding-left: 20px; margin: 10px 0; }
      .markdown-body ol { list-style-type: decimal; padding-left: 20px; margin: 10px 0; }
      .markdown-body h1 { font-size: 1.5em; font-weight: bold; margin-top: 20px; margin-bottom: 10px; color: white; border-bottom: 1px solid #334155; padding-bottom: 5px; }
      .markdown-body h2 { font-size: 1.3em; font-weight: bold; margin-top: 15px; margin-bottom: 10px; color: white; }
      .markdown-body blockquote { border-left: 4px solid #10b981; padding-left: 10px; color: #94a3b8; margin: 10px 0; font-style: italic; }
      .markdown-body table { width: 100%; border-collapse: collapse; margin: 15px 0; }
      .markdown-body th, .markdown-body td { border: 1px solid #334155; padding: 8px; text-align: left; }
      .markdown-body th { background-color: #1e293b; color: #10b981; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- 1. CONFIGURATION ---
        const API_URL = "https://script.google.com/macros/s/AKfycbwsng4RBCTX67my46U4fv7BhDYT0CIZt95dL7DNCFJTGUJLZFd_854vRGeUsQ1_BjG9/exec"; // ‚ö†Ô∏è Ë´ãÂãôÂøÖÊõ¥ÊèõÔºÅ

        const AppMode = {
            CHAT: 'chat', SEARCH: 'search', REPORT: 'report', PRESENTATION: 'presentation', DRAWING: 'drawing'
        };

        const PPT_THEMES = [
          { value: "modern_blue", label: "üîµ ÁßëÊäÄËóç" },
          { value: "warm_orange", label: "üü† Ê∫´ÊöñÊ©ò" },
          { value: "forest_green", label: "üü¢ Ê£ÆÊûóÁ∂†" },
          { value: "dark_cyber", label: "‚ö´ ÊöóÈªëÁ≥ª" },
        ];

        const PPT_MODES = [
          { value: "hybrid", label: "‚ú® Ê∑∑Âêà (Content-Aware)" },
          { value: "geometric", label: "üìê Á¥îÂπæ‰Ωï (Native)" },
          { value: "ai_visual", label: "üé® Á¥î AI ÂúñÂÉè (Visual)" },
        ];

        // --- 2. API SERVICE ---
        const callBackend = async (payload) => {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload),
                });
                return await response.json();
            } catch (error) { return { status: 'error', error: error.message || "Network Error" }; }
        };
        const fetchSessions = () => callBackend({ mode: 'system', action: 'get_session_list' });
        const loadSessionApi = (sessionId) => callBackend({ mode: 'system', action: 'load_session', session_id: sessionId });

        // --- 3. COMPONENTS ---

        // ÂÅ¥ÈÇäÊ¨ÑÔºöÊ≠∑Âè≤Á¥ÄÈåÑ
        const Sidebar = ({ isOpen, sessions, currentSessionId, onNewChat, onSelectSession, onDeleteSession, isCollapsed, toggleCollapse }) => {
            const groupedSessions = useMemo(() => {
                const today = new Date();
                const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
                const groups = { today: [], yesterday: [], older: [] };
                sessions.forEach(s => {
                    const d = new Date(s.timestamp || Date.now());
                    if (d.toDateString() === today.toDateString()) groups.today.push(s);
                    else if (d.toDateString() === yesterday.toDateString()) groups.yesterday.push(s);
                    else groups.older.push(s);
                });
                return groups;
            }, [sessions]);

            const renderGroup = (title, list) => {
                if (list.length === 0) return null;
                return (
                    <div className="mb-4">
                        {!isCollapsed && <div className="text-[10px] font-bold text-slate-500 uppercase px-4 mb-2 tracking-wider animate-fade-in">{title}</div>}
                        {list.map(s => (
                            <div key={s.id} onClick={() => onSelectSession(s.id)} className={`group relative flex items-center px-3 py-2 rounded-lg cursor-pointer transition-all mx-2 mb-1 ${s.id === currentSessionId ? 'bg-slate-800 text-white' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'}`} title={isCollapsed ? s.title : ''}>
                                <div className="min-w-[20px] flex justify-center"><i className="far fa-message text-xs opacity-70"></i></div>
                                {!isCollapsed && <div className="ml-3 truncate text-sm flex-1">{s.title || "Êú™ÂëΩÂêç"}</div>}
                            </div>
                        ))}
                    </div>
                );
            };

            const sidebarWidth = isCollapsed ? 'w-[60px]' : 'w-[260px]';
            return (
                <aside className={`${sidebarWidth} h-full bg-[#0f172a] flex flex-col transition-all duration-300 border-r border-slate-800 z-50 fixed md:relative ${isOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
                    <div className="p-3 pt-4 flex flex-col gap-4">
                        <div className="flex items-center justify-between px-2">
                            <button onClick={toggleCollapse} className="p-2 text-slate-400 hover:text-white rounded-lg hover:bg-slate-800 hidden md:block"><i className="fas fa-bars"></i></button>
                            {!isCollapsed && <div className="text-emerald-500 font-bold text-sm tracking-wide">anyGem v60.3</div>}
                            <button onClick={() => {}} className="md:hidden p-2 text-slate-400" ><i className="fas fa-times"></i></button>
                        </div>
                        <button onClick={onNewChat} className={`flex items-center gap-3 bg-slate-800 hover:bg-slate-700 text-slate-200 transition-all rounded-lg p-2.5 ${isCollapsed ? 'justify-center mx-auto' : 'px-4 mx-2'}`}>
                            <i className="fas fa-plus text-primary"></i>
                            {!isCollapsed && <span className="font-medium text-sm">New Chat</span>}
                        </button>
                    </div>
                    <div className="flex-1 overflow-y-auto py-2 custom-scrollbar">
                        {renderGroup("Today", groupedSessions.today)}
                        {renderGroup("Yesterday", groupedSessions.yesterday)}
                        {renderGroup("Older", groupedSessions.older)}
                    </div>
                </aside>
            );
        };

        // Ë®äÊÅØÊ∞£Ê≥°
        const MessageBubble = ({ message }) => {
            const isUser = message.role === 'user';
            const htmlContent = useMemo(() => marked.parse(message.text || ""), [message.text]);
            return (
                <div className={`flex w-full mb-6 ${isUser ? 'justify-end' : 'justify-start'}`}>
                    <div className={`relative max-w-[85%] md:max-w-[75%] rounded-2xl p-4 text-sm leading-relaxed ${isUser ? 'bg-emerald-700 text-white rounded-tr-sm' : 'bg-slate-800 border border-slate-700 text-slate-200 rounded-tl-sm shadow-xl'}`}>
                        {message.meta?.fileName && <div className="flex items-center gap-2 mb-3 bg-black/20 p-2 rounded text-xs"><i className="fas fa-paperclip"></i><span className="font-mono">{message.meta.fileName}</span></div>}
                        <div className="markdown-body">
                            {message.meta?.image && <img src={`data:${message.meta.mime};base64,${message.meta.image}`} className="rounded-lg mb-4 max-w-full"/>}
                            <div dangerouslySetInnerHTML={{ __html: htmlContent }} />
                        </div>
                    </div>
                </div>
            );
        };

        // Âè≥ÂÅ¥Ë®≠ÂÆöÈù¢Êùø (Canvas)
        const Canvas = ({ isOpen, mode, pptOptions, setPptOptions, reportStyle, setReportStyle }) => {
            return (
                <div className={`hidden lg:flex flex-col h-full bg-surface border-slate-800 transition-all duration-300 ease-in-out overflow-hidden ${isOpen ? 'w-[320px] border-l p-5 opacity-100' : 'w-0 p-0 opacity-0 border-none'}`}>
                    <div className="min-w-[280px]">
                        {mode === AppMode.PRESENTATION && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="flex items-center gap-2 mb-2"><i className="fas fa-sliders-h text-primary"></i><h2 className="text-lg font-bold text-white">Á∞°Â†±ÂºïÊìé</h2></div>
                                <div className="space-y-4">
                                    <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">ÁîüÊàêÊ®°Âºè</label><select value={pptOptions.pptMode} onChange={(e) => setPptOptions({...pptOptions, pptMode: e.target.value})} className="w-full bg-slate-900 border border-slate-700 text-white p-2 rounded-lg text-sm outline-none">{PPT_MODES.map(m => <option key={m.value} value={m.value}>{m.label}</option>)}</select></div>
                                    <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">ÈÖçËâ≤‰∏ªÈ°å</label><div className="grid grid-cols-2 gap-2">{PPT_THEMES.map(t => <button key={t.value} onClick={() => setPptOptions({...pptOptions, theme: t.value})} className={`p-2 rounded border text-xs text-left ${pptOptions.theme === t.value ? 'bg-primary/20 border-primary text-white' : 'bg-slate-900 border-slate-700 text-slate-400'}`}>{t.label.split(' ')[1]}</button>)}</div></div>
                                    <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">È†ÅÊï∏: {pptOptions.length}</label><input type="range" min="3" max="20" value={pptOptions.length} onChange={(e) => setPptOptions({...pptOptions, length: parseInt(e.target.value)})} className="w-full accent-primary"/></div>
                                </div>
                            </div>
                        )}
                        {mode === AppMode.REPORT && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="flex items-center gap-2 mb-2"><i className="fas fa-file-contract text-primary"></i><h2 className="text-lg font-bold text-white">Á†îÂ†±Ë®≠ÂÆö</h2></div>
                                <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Ë™ûÊ∞£È¢®Ê†º</label><input type="text" value={reportStyle} onChange={(e) => setReportStyle(e.target.value)} className="w-full bg-slate-900 border border-slate-700 text-white p-2 rounded-lg text-sm outline-none"/></div>
                            </div>
                        )}
                         {(mode !== AppMode.PRESENTATION && mode !== AppMode.REPORT) && <div className="text-center text-slate-500 mt-20"><i className="fas fa-layer-group text-4xl mb-4 opacity-30"></i><p className="text-sm">Ê≠§Ê®°ÂºèÁÑ°ÈÄ≤ÈöéË®≠ÂÆö</p></div>}
                    </div>
                </div>
            );
        };

        // Main App
        const App = () => {
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
            const [showRightPanel, setShowRightPanel] = useState(true);
            const [mode, setMode] = useState(AppMode.CHAT);
            const [input, setInput] = useState('');
            const [messages, setMessages] = useState([]);
            const [loading, setLoading] = useState(false);
            const [activeFile, setActiveFile] = useState(null);
            const [sessions, setSessions] = useState([]);
            const [currentSessionId, setCurrentSessionId] = useState(localStorage.getItem('ANYGEM_USER_ID') || `UID_${Date.now()}`);
            const [pptOptions, setPptOptions] = useState({ length: 6, density: 'detailed', theme: 'modern_blue', pptMode: 'hybrid', visualStyle: '' });
            const [reportStyle, setReportStyle] = useState('Professional');
            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);

            useEffect(() => { localStorage.setItem('ANYGEM_USER_ID', currentSessionId); loadHistoryList(); if(messages.length===0) setMessages([{ id: 'welcome', role: 'ai', text: "üëã **Ê≠°Ëøé‰ΩøÁî® anyGem v60.3**\n\nÊàëÊòØÊÇ®ÁöÑ AI Êô∫ËÉΩÂä©Êâã„ÄÇË´ãÈÅ∏Êìá‰∏äÊñπÊ®°ÂºèÈñãÂßã‰ΩøÁî®„ÄÇ", timestamp: Date.now() }]); }, [currentSessionId]);
            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

            const loadHistoryList = async () => { const data = await fetchSessions(); if (data.sessions) setSessions(data.sessions); };
            const handleNewChat = () => { const newId = `UID_${Date.now()}`; setCurrentSessionId(newId); setMessages([]); setMode(AppMode.CHAT); };
            const loadSessionHandler = async (id) => { setCurrentSessionId(id); const data = await loadSessionApi(id); if(data.logs) setMessages(data.logs.map((l,i)=>({id:`${id}_${i}`, role:l.role, text:l.text, timestamp:Date.now()}))); };
            const handleSend = async () => {
                if (!input.trim() && !activeFile) return;
                const userMsg = { id: Date.now().toString(), role: 'user', text: input, timestamp: Date.now(), meta: { fileName: activeFile?.name } };
                setMessages(prev => [...prev, userMsg]);
                setInput(''); setLoading(true);
                let fileData = undefined;
                if (activeFile) fileData = await new Promise(r => { const reader = new FileReader(); reader.onload = e => r(e.target.result); reader.readAsDataURL(activeFile); });
                const payload = { message: userMsg.text, session_id: currentSessionId, mode: mode, file_data: fileData ? fileData.split(',')[1] : undefined, mime_type: activeFile?.type, options: { ...pptOptions, style: reportStyle } };
                setActiveFile(null);
                const response = await sendMessage(payload);
                setLoading(false);
                if (response.status === 'success') {
                    setMessages(prev => [...prev, { id: (Date.now() + 1).toString(), role: 'ai', text: response.reply || "ÂÆåÊàê„ÄÇ", timestamp: Date.now(), meta: { model: response.model, image: response.image, mime: response.mime } }]);
                    loadHistoryList();
                } else setMessages(prev => [...prev, { id: Date.now().toString(), role: 'system', text: `üö® ÈåØË™§: ${response.error}`, timestamp: Date.now() }]);
            };
            const sendMessage = (payload) => callBackend(payload);

            return (
                <div className="flex h-screen bg-slate-950 text-slate-200 font-sans overflow-hidden">
                    <Sidebar isOpen={sidebarOpen} sessions={sessions} currentSessionId={currentSessionId} onNewChat={handleNewChat} onSelectSession={loadSessionHandler} isCollapsed={sidebarCollapsed} toggleCollapse={() => setSidebarCollapsed(!sidebarCollapsed)}/>
                    <div className="flex-1 flex flex-col h-full relative">
                        <header className="h-14 border-b border-slate-800 flex items-center px-4 justify-between bg-slate-900/50 backdrop-blur-sm z-10">
                            <div className="flex items-center gap-3">
                                <button onClick={() => setSidebarOpen(!sidebarOpen)} className="md:hidden text-slate-400"><i className="fas fa-bars"></i></button>
                                <div className="font-bold text-white tracking-wide">anyGem <span className="text-primary font-normal">Next</span></div>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="flex items-center bg-slate-800 rounded-lg p-1">{Object.values(AppMode).map((m) => <button key={m} onClick={() => setMode(m)} className={`px-3 py-1 rounded-md text-xs font-medium transition-all capitalize ${mode === m ? 'bg-primary text-white shadow' : 'text-slate-400 hover:text-slate-200'}`}>{m === 'chat' ? 'üí¨' : m === 'presentation' ? 'üìä' : m.slice(0,1).toUpperCase()+m.slice(1)}</button>)}</div>
                                <button onClick={() => setShowRightPanel(!showRightPanel)} className={`hidden lg:flex p-2 rounded hover:bg-slate-800 ${showRightPanel ? 'text-primary' : 'text-slate-400'}`}><i className="fas fa-columns"></i></button>
                            </div>
                        </header>
                        <div className="flex-1 flex overflow-hidden">
                            <div className="flex-1 flex flex-col relative transition-all duration-300">
                                <div className="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth"><div className="max-w-3xl mx-auto">{messages.map((msg) => <MessageBubble key={msg.id} message={msg} />)}{loading && <div className="flex justify-start w-full mb-6 animate-pulse"><div className="bg-slate-800 rounded-2xl rounded-tl-sm p-4 text-slate-400 text-sm flex items-center gap-2"><i className="fas fa-circle-notch fa-spin text-primary"></i>ËôïÁêÜ‰∏≠...</div></div>}<div ref={messagesEndRef} /></div></div>
                                <div className="p-4 border-t border-slate-800 bg-slate-900/80 backdrop-blur-md">
                                    <div className="max-w-3xl mx-auto relative">
                                        {activeFile && <div className="absolute -top-12 left-0 bg-slate-800 text-xs px-3 py-2 rounded-lg border border-slate-700 flex items-center gap-2"><i className="fas fa-file"></i> {activeFile.name}<button onClick={() => setActiveFile(null)} className="hover:text-red-400"><i className="fas fa-times"></i></button></div>}
                                        <div className="flex items-end gap-2 bg-slate-800/50 border border-slate-700 rounded-xl p-2 focus-within:border-primary/50 transition-all">
                                            <button onClick={() => fileInputRef.current?.click()} className="p-3 text-slate-400 hover:text-white"><i className="fas fa-paperclip"></i></button>
                                            <input type="file" ref={fileInputRef} className="hidden" onChange={(e) => setActiveFile(e.target.files[0])} />
                                            <textarea value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } }} placeholder={`Âú® ${mode} Ê®°Âºè‰∏ãËº∏ÂÖ•...`} className="flex-1 bg-transparent border-none outline-none text-slate-200 text-sm resize-none py-3" rows={1} style={{ minHeight: '44px' }} />
                                            <button onClick={handleSend} disabled={loading || (!input.trim() && !activeFile)} className="p-3 bg-primary hover:bg-emerald-600 text-white rounded-lg disabled:opacity-50"><i className="fas fa-paper-plane"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <Canvas isOpen={showRightPanel} mode={mode} pptOptions={pptOptions} setPptOptions={setPptOptions} reportStyle={reportStyle} setReportStyle={setReportStyle} />
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
