<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>anyGem v50.0 : Consultative Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #020617; color: #cbd5e1; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .chat-bubble { max-width: 85%; padding: 1rem; border-radius: 1.5rem; margin-bottom: 1.5rem; animation: fadeInUp 0.4s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .user-bubble { background: #059669; color: white; margin-left: auto; border-bottom-right-radius: 0; }
        .ai-bubble { background: #1e293b; border: 1px solid rgba(16, 185, 129, 0.1); border-bottom-left-radius: 0; }
        #options-panel { transition: all 0.4s; max-height: 0; overflow: hidden; opacity: 0; }
        #options-panel.active { max-height: 200px; opacity: 1; padding: 1rem 0; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="p-4 glass sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-black italic text-white tracking-tighter uppercase">anyGem <span class="text-emerald-500 text-sm">v50</span></h1>
            <select id="mode-select" onchange="updateUI()" class="bg-slate-800 text-white text-xs py-2 px-3 rounded-xl border border-emerald-500/30 outline-none">
                <option value="chat">ğŸ’¬ æ™ºèƒ½åŠ©ç†</option>
                <option value="search">ğŸŒ æ·±åº¦ç ”ç©¶ (è«®è©¢æ¨¡å¼)</option>
                <option value="drawing">ğŸ¨ è—è¡“ç”Ÿåœ–</option>
                <option value="presentation">ğŸ“Š æ™ºèƒ½ç°¡å ±</option>
            </select>
        </div>
    </header>

    <main id="chat-window" class="flex-1 overflow-y-auto p-4 max-w-4xl mx-auto w-full pb-32"></main>

    <footer class="p-4 glass fixed bottom-0 left-0 right-0">
        <div class="max-w-4xl mx-auto">
            <div id="options-panel" class="border-t border-white/5">
                <div class="flex items-center gap-2 text-xs font-bold text-emerald-400">
                    <input type="checkbox" id="create-report-check" checked> 
                    <label for="create-report-check" class="cursor-pointer">å•Ÿå‹•å¾Œè‡ªå‹•ç”Ÿæˆæ­£å¼ç ”ç©¶å ±å‘Š (Google Doc)</label>
                </div>
            </div>
            <div class="flex gap-2 items-end">
                <input type="file" id="file-input" class="hidden">
                <button onclick="document.getElementById('file-input').click()" class="p-4 bg-slate-800 rounded-2xl text-emerald-500 hover:bg-emerald-500/10 transition-all"><i class="fas fa-paperclip"></i></button>
                <textarea id="user-input" rows="1" class="flex-1 bg-slate-800 rounded-2xl p-4 text-white text-sm outline-none focus:ring-1 focus:ring-emerald-500 resize-none" placeholder="è¼¸å…¥ä¸»é¡Œé–‹å§‹è«®è©¢..."></textarea>
                <button onclick="handleSend()" id="send-btn" class="p-4 bg-emerald-600 rounded-2xl text-white hover:bg-emerald-500 active:scale-95 transition-all"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </footer>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwsng4RBCTX67my46U4fv7BhDYT0CIZt95dL7DNCFJTGUJLZFd_854vRGeUsQ1_BjG9/exec"; 
        let sessId = "SESS_" + Math.random().toString(36).substr(2, 9).toUpperCase();
        const chatWindow = document.getElementById('chat-window'), input = document.getElementById('user-input');

        function updateUI() {
            const m = document.getElementById('mode-select').value;
            document.getElementById('options-panel').classList.toggle('active', m === 'search');
            input.placeholder = m === 'search' ? "è¼¸å…¥ç ”ç©¶ä¸»é¡Œï¼Œé–‹å•Ÿ PM è«®è©¢..." : "è¼¸å…¥è¨Šæ¯...";
        }

        async function handleSend() {
            const text = input.value.trim(); if(!text) return;
            addMessage('user', text); input.value = '';
            
            const payload = {
                message: text, session_id: sessId, mode: document.getElementById('mode-select').value,
                options: { create_report: document.getElementById('create-report-check').checked }
            };

            setLoading(true, payload.mode === 'search' ? "PM æ­£åœ¨åˆ†æè¦æ ¼..." : "AI è™•ç†ä¸­...");
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                const data = await res.json();
                if(data.status === "success") addMessage('ai', data.reply, data.image);
                else addMessage('ai', "ğŸš¨ éŒ¯èª¤: " + data.error);
            } catch (e) { addMessage('ai', "âŒ é€£ç·šå¤±æ•—"); }
            finally { setLoading(false); }
        }

        function addMessage(role, text, image = null) {
            const div = document.createElement('div');
            div.className = `chat-bubble ${role === 'user' ? 'user-bubble' : 'ai-bubble'}`;
            let html = marked.parse(text);
            if(image) html += `<img src="data:image/png;base64,${image}" class="mt-4 rounded-xl shadow-2xl w-full border border-white/5">`;
            div.innerHTML = html;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function setLoading(b, text) {
            document.getElementById('send-btn').disabled = b;
            if(b) {
                const l = document.createElement('div'); l.id = "loader";
                l.className = "text-center text-emerald-500 text-[10px] font-bold animate-pulse p-4";
                l.innerText = "âš¡ " + text.toUpperCase();
                chatWindow.appendChild(l);
            } else { document.getElementById('loader')?.remove(); }
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        updateUI();
    </script>
</body>
</html>
