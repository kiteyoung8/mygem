<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>anyGem Next</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel (for compiling JSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Marked (for Markdown parsing) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              background: '#0f172a',
              surface: '#1e293b',
              primary: '#10b981',
              accent: '#34d399',
            },
            animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
            keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
          }
        }
      }
    </script>
    <style>
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }
      body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif; }
      
      /* Markdown Styles */
      .markdown-body img { max-width: 100%; border-radius: 8px; margin: 10px 0; border: 1px solid #334155; }
      .markdown-body pre { background: #0f172a; padding: 12px; border-radius: 6px; overflow-x: auto; margin: 10px 0; border: 1px solid #334155; }
      .markdown-body code { font-family: monospace; background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 3px; color: #e2e8f0; font-size: 0.9em; }
      .markdown-body pre code { background: transparent; padding: 0; color: #a5b4fc; }
      .markdown-body a { color: #34d399; text-decoration: none; border-bottom: 1px dashed #34d399; }
      .markdown-body a:hover { border-bottom-style: solid; }
      .markdown-body ul { list-style-type: disc; padding-left: 20px; margin: 10px 0; }
      .markdown-body ol { list-style-type: decimal; padding-left: 20px; margin: 10px 0; }
      .markdown-body h1 { font-size: 1.5em; font-weight: bold; margin-top: 20px; margin-bottom: 10px; color: white; border-bottom: 1px solid #334155; padding-bottom: 5px; }
      .markdown-body h2 { font-size: 1.3em; font-weight: bold; margin-top: 15px; margin-bottom: 10px; color: white; }
      .markdown-body h3 { font-size: 1.1em; font-weight: bold; margin-top: 10px; margin-bottom: 5px; color: #e2e8f0; }
      .markdown-body blockquote { border-left: 4px solid #10b981; padding-left: 10px; color: #94a3b8; margin: 10px 0; font-style: italic; }
      .markdown-body table { width: 100%; border-collapse: collapse; margin: 15px 0; }
      .markdown-body th, .markdown-body td { border: 1px solid #334155; padding: 8px; text-align: left; }
      .markdown-body th { background-color: #1e293b; color: #10b981; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/",
    "react-markdown": "https://esm.sh/react-markdown@^10.1.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- 1. CONFIGURATION & TYPES ---
        
        // âš ï¸ é‡è¦ï¼šè«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨ Google Apps Script éƒ¨ç½²å¾Œçš„ Web App URL
        const API_URL = "https://script.google.com/macros/s/AKfycbwsng4RBCTX67my46U4fv7BhDYT0CIZt95dL7DNCFJTGUJLZFd_854vRGeUsQ1_BjG9/exec";

        const AppMode = {
            CHAT: 'chat',
            SEARCH: 'search',
            REPORT: 'report',
            PRESENTATION: 'presentation',
            DRAWING: 'drawing'
        };

        const PPT_THEMES = [
          { value: "modern_blue", label: "ğŸ”µ ç§‘æŠ€è— (Tech Blue)" },
          { value: "warm_orange", label: "ğŸŸ  æº«æš–æ©˜ (Warm Orange)" },
          { value: "forest_green", label: "ğŸŸ¢ æ£®æ—ç¶  (Forest Green)" },
          { value: "dark_cyber", label: "âš« æš—é»‘ç³» (Dark Cyber)" },
        ];

        const PPT_MODES = [
          { value: "hybrid", label: "âœ¨ æ··åˆ (Hybrid)" },
          { value: "geometric", label: "ğŸ“ ç´”å¹¾ä½• (Geometric)" },
          { value: "ai_visual", label: "ğŸ¨ ç´” AI åœ–åƒ (Visual)" },
        ];

        // --- 2. API SERVICE ---

        const callBackend = async (payload) => {
            try {
                // CORS Hack: Use text/plain to avoid OPTIONS preflight
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload),
                });
                return await response.json();
            } catch (error) {
                console.error("API Error:", error);
                return { status: 'error', error: error.message || "Network Error" };
            }
        };

        const sendMessage = (payload) => callBackend(payload);
        const fetchSessions = () => callBackend({ mode: 'system', action: 'get_session_list' });
        const loadSessionApi = (sessionId) => callBackend({ mode: 'system', action: 'load_session', session_id: sessionId });

        // --- 3. COMPONENTS ---

        // Sidebar Component
        const Sidebar = ({ isOpen, sessions, currentSessionId, onNewChat, onSelectSession, onDeleteSession, isCollapsed, toggleCollapse }) => {
            
            const groupedSessions = useMemo(() => {
                const today = new Date();
                const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
                const sevenDaysAgo = new Date(today); sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                const groups = { today: [], yesterday: [], previous7: [], older: [] };

                sessions.forEach(s => {
                    const d = new Date(s.timestamp || Date.now());
                    if (d.toDateString() === today.toDateString()) groups.today.push(s);
                    else if (d.toDateString() === yesterday.toDateString()) groups.yesterday.push(s);
                    else if (d > sevenDaysAgo) groups.previous7.push(s);
                    else groups.older.push(s);
                });
                return groups;
            }, [sessions]);

            const renderGroup = (title, list) => {
                if (list.length === 0) return null;
                return (
                    <div className="mb-4">
                        {!isCollapsed && <div className="text-[11px] font-bold text-slate-500 uppercase px-4 mb-2 tracking-wider animate-fade-in">{title}</div>}
                        {list.map(s => (
                            <div 
                                key={s.id} 
                                onClick={() => onSelectSession(s.id)}
                                className={`group relative flex items-center px-3 py-2 rounded-full cursor-pointer transition-all mx-2 mb-1 
                                    ${s.id === currentSessionId ? 'bg-slate-700/50 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}
                                `}
                                title={isCollapsed ? s.title : ''}
                            >
                                <div className="min-w-[20px] flex justify-center"><i className="far fa-message text-sm opacity-70"></i></div>
                                {!isCollapsed && (
                                    <>
                                        <div className="ml-3 truncate text-sm flex-1">{s.title || "æœªå‘½åå°è©±"}</div>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); onDeleteSession(s.id); }}
                                            className="opacity-0 group-hover:opacity-100 p-1 hover:text-red-400 text-slate-500 transition-opacity absolute right-2 bg-slate-800 shadow-lg rounded-full"
                                        >
                                            <i className="fas fa-times"></i>
                                        </button>
                                    </>
                                )}
                            </div>
                        ))}
                    </div>
                );
            };

            const sidebarWidth = isCollapsed ? 'w-[68px]' : 'w-[280px]';

            return (
                <aside className={`${sidebarWidth} h-full bg-[#0f172a] flex flex-col transition-all duration-300 ease-in-out border-r border-slate-800 z-50 fixed md:relative ${isOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
                    <div className="p-3 pt-4 flex flex-col gap-4">
                        <div className="flex items-center justify-between px-2">
                            <button onClick={toggleCollapse} className="p-2 text-slate-400 hover:text-white rounded-full hover:bg-slate-800 transition-colors hidden md:block" title={isCollapsed ? "å±•é–‹å´é‚Šæ¬„" : "æ”¶åˆå´é‚Šæ¬„"}>
                                <i className="fas fa-bars text-lg"></i>
                            </button>
                            {!isCollapsed && <div className="text-slate-500 text-xs font-mono whitespace-nowrap overflow-hidden">ANYGEM v60.2</div>}
                            <button onClick={() => {}} className="md:hidden p-2 text-slate-400" ><i className="fas fa-times"></i></button>
                        </div>
                        
                        <button 
                            onClick={onNewChat}
                            className={`flex items-center gap-3 bg-slate-800 hover:bg-slate-700 text-slate-200 transition-all rounded-full p-3 ${isCollapsed ? 'justify-center w-10 h-10 mx-auto' : 'px-4 mx-2'}`}
                            title="æ–°å¢å°è©±"
                        >
                            <i className="fas fa-plus text-primary"></i>
                            {!isCollapsed && <span className="font-medium text-sm whitespace-nowrap">æ–°å¢å°è©±</span>}
                        </button>
                    </div>

                    <div className="flex-1 overflow-y-auto overflow-x-hidden py-2 custom-scrollbar">
                        {renderGroup("ä»Šå¤©", groupedSessions.today)}
                        {renderGroup("æ˜¨å¤©", groupedSessions.yesterday)}
                        {renderGroup("éå» 7 å¤©", groupedSessions.previous7)}
                        {renderGroup("æ›´æ—©ä¹‹å‰", groupedSessions.older)}
                        {sessions.length === 0 && !isCollapsed && <div className="text-center text-slate-600 text-xs mt-10">å°šç„¡æ­·å²ç´€éŒ„</div>}
                    </div>

                    <div className="p-3 border-t border-slate-800">
                         <div className={`flex items-center gap-3 p-2 rounded-full hover:bg-slate-800 cursor-pointer transition-colors ${isCollapsed ? 'justify-center' : ''}`}>
                             <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-primary to-blue-500 flex items-center justify-center text-white font-bold text-xs shrink-0">A</div>
                             {!isCollapsed && (
                                 <div className="flex flex-col overflow-hidden">
                                     <span className="text-sm text-slate-200 font-medium truncate">User</span>
                                     <span className="text-[10px] text-slate-500 truncate">Free Plan</span>
                                 </div>
                             )}
                         </div>
                    </div>
                </aside>
            );
        };

        // MessageBubble Component
        const MessageBubble = ({ message }) => {
            const isUser = message.role === 'user';
            
            // ä½¿ç”¨ marked åº«å°‡ Markdown è½‰æ›ç‚º HTML
            const htmlContent = useMemo(() => {
                if (!message.text) return "";
                return marked.parse(message.text);
            }, [message.text]);

            return (
                <div className={`flex w-full mb-6 ${isUser ? 'justify-end' : 'justify-start'}`}>
                    <div className={`relative max-w-[85%] md:max-w-[75%] rounded-2xl p-4 md:p-5 text-sm md:text-base leading-relaxed ${isUser ? 'bg-emerald-700 text-white rounded-tr-sm' : 'bg-slate-800 border border-slate-700 text-slate-200 rounded-tl-sm shadow-xl'}`}>
                        {message.meta?.fileName && <div className="flex items-center gap-2 mb-3 bg-black/20 p-2 rounded text-xs"><i className="fas fa-paperclip"></i><span className="font-mono">{message.meta.fileName}</span></div>}
                        
                        <div className="markdown-body">
                            {message.meta?.image && <img src={`data:${message.meta.mime};base64,${message.meta.image}`} alt="Generated" className="rounded-lg mb-4 max-w-full border border-slate-700"/>}
                            
                            {/* Render HTML content */}
                            <div dangerouslySetInnerHTML={{ __html: htmlContent }} />
                        </div>
                        
                        {!isUser && <div className="mt-3 flex items-center justify-between border-t border-slate-700/50 pt-2"><div className="text-[10px] text-slate-500">{message.meta?.model || "anyGem AI"}</div><button onClick={() => navigator.clipboard.writeText(message.text)} className="text-slate-500 hover:text-white text-xs transition-colors"><i className="fas fa-copy"></i></button></div>}
                    </div>
                </div>
            );
        };

        // Canvas Component
        const Canvas = ({ isOpen, mode, pptOptions, setPptOptions, reportStyle, setReportStyle, activeFile }) => {
            return (
                <div className={`hidden lg:flex flex-col h-full bg-surface border-slate-800 transition-all duration-300 ease-in-out overflow-hidden ${isOpen ? 'w-[350px] border-l p-6 opacity-100' : 'w-0 p-0 opacity-0 border-none'}`}>
                    <div className="min-w-[300px]"> {/* Container to prevent content squishing during transition */}
                        {mode === AppMode.CHAT && !activeFile ? (
                            <div className="flex flex-col items-center justify-center h-[80vh] text-slate-600">
                                <div className="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mb-6"><i className="fas fa-layer-group text-3xl text-slate-700"></i></div>
                                <h3 className="text-base font-medium text-slate-500">å·¥ä½œå€ç©ºç™½</h3>
                                <p className="text-center text-xs mt-2 max-w-xs px-4">è«‹åˆ‡æ›è‡³ã€Œç°¡å ±ã€æˆ–ã€Œç ”å ±ã€æ¨¡å¼ä»¥å•Ÿç”¨é€²éšè¨­å®šã€‚</p>
                            </div>
                        ) : (
                            <>
                                {activeFile && (
                                    <div className="mb-8 p-4 bg-slate-900 rounded-xl border border-slate-700 animate-fade-in">
                                        <div className="flex items-start gap-3">
                                            <div className="w-10 h-10 bg-slate-800 rounded-lg flex items-center justify-center text-emerald-500"><i className="fas fa-file-alt text-xl"></i></div>
                                            <div><div className="text-sm font-bold text-white break-all line-clamp-2">{activeFile.name}</div><div className="text-xs text-slate-500 mt-1">æº–å‚™å°±ç·’</div></div>
                                        </div>
                                    </div>
                                )}
                                <div className="animate-fade-in">
                                    {mode === AppMode.PRESENTATION && (
                                        <div className="space-y-6">
                                            <div className="flex items-center gap-2 mb-2"><i className="fas fa-sliders-h text-primary"></i><h2 className="text-lg font-bold text-white">ç°¡å ±å¼•æ“è¨­å®š</h2></div>
                                            <div className="space-y-4">
                                                <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">ç”Ÿæˆæ¨¡å¼</label><select value={pptOptions.pptMode} onChange={(e) => setPptOptions({...pptOptions, pptMode: e.target.value})} className="w-full bg-slate-900 border border-slate-700 text-white p-2.5 rounded-lg focus:border-primary outline-none text-sm">{PPT_MODES.map(m => <option key={m.value} value={m.value}>{m.label}</option>)}</select></div>
                                                <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">é…è‰²ä¸»é¡Œ</label><div className="grid grid-cols-2 gap-2">{PPT_THEMES.map(t => <button key={t.value} onClick={() => setPptOptions({...pptOptions, theme: t.value})} className={`p-2 rounded-lg border text-xs text-left transition-all ${pptOptions.theme === t.value ? 'bg-primary/20 border-primary text-white' : 'bg-slate-900 border-slate-700 text-slate-400'}`}>{t.label.split(' ')[1]}</button>)}</div></div>
                                                <div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">é æ•¸</label><input type="number" min="3" max="20" value={pptOptions.length} onChange={(e) => setPptOptions({...pptOptions, length: parseInt(e.target.value)})} className="w-full bg-slate-900 border border-slate-700 text-white p-2 rounded-lg focus:border-primary outline-none text-sm"/></div>
                                                <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">å…§å®¹æ·±åº¦</label><select value={pptOptions.density} onChange={(e) => setPptOptions({...pptOptions, density: e.target.value})} className="w-full bg-slate-900 border border-slate-700 text-white p-2 rounded-lg focus:border-primary outline-none text-sm"><option value="detailed">è©³ç´°å…§å®¹</option><option value="brief">é‡é»æ‘˜è¦</option></select></div></div>
                                                <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">è¦–è¦ºé¢¨æ ¼ (æç¤ºè©)</label><input type="text" placeholder="ä¾‹å¦‚ï¼šCyberpunk, æ¥µç°¡é¢¨..." value={pptOptions.visualStyle} onChange={(e) => setPptOptions({...pptOptions, visualStyle: e.target.value})} className="w-full bg-slate-900 border border-slate-700 text-white p-2 rounded-lg focus:border-primary outline-none text-sm"/></div>
                                            </div>
                                        </div>
                                    )}
                                    {mode === AppMode.REPORT && (
                                        <div className="space-y-6">
                                            <div className="flex items-center gap-2 mb-2"><i className="fas fa-file-contract text-primary"></i><h2 className="text-lg font-bold text-white">ç ”å ±è¨­å®š</h2></div>
                                            <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">èªæ°£èˆ‡é¢¨æ ¼</label><input type="text" value={reportStyle} onChange={(e) => setReportStyle(e.target.value)} placeholder="ä¾‹å¦‚ï¼šå­¸è¡“åš´è¬¹ã€å•†æ¥­åˆ†æ..." className="w-full bg-slate-900 border border-slate-700 text-white p-2.5 rounded-lg focus:border-primary outline-none text-sm"/></div>
                                            <p className="text-xs text-slate-500">AI å°‡é€²è¡Œæ·±åº¦ç ”ç©¶ä¸¦ç”Ÿæˆ Google Doc é€£çµã€‚</p>
                                        </div>
                                    )}
                                    {mode === AppMode.SEARCH && (
                                        <div className="mt-auto bg-blue-900/20 p-4 rounded-lg border border-blue-500/30"><h4 className="text-blue-400 font-bold text-sm mb-1"><i className="fas fa-globe"></i> æ·±åº¦æœå°‹å•Ÿç”¨ä¸­</h4><p className="text-xs text-blue-200/70">AI å°‡ç€è¦½å¤šå€‹ä¾†æºä»¥æä¾›æœ‰ä¾æ“šçš„å›ç­”ï¼Œä¸¦é™„ä¸Šå¼•ç”¨ä¾†æºã€‚</p></div>
                                    )}
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
            const [showRightPanel, setShowRightPanel] = useState(true);
            const [mode, setMode] = useState(AppMode.CHAT);
            const [input, setInput] = useState('');
            const [messages, setMessages] = useState([]);
            const [loading, setLoading] = useState(false);
            const [activeFile, setActiveFile] = useState(null);
            const [sessions, setSessions] = useState([]);
            const [currentSessionId, setCurrentSessionId] = useState(localStorage.getItem('ANYGEM_USER_ID') || `UID_${Date.now()}`);
            const [pptOptions, setPptOptions] = useState({ length: 6, density: 'detailed', theme: 'modern_blue', pptMode: 'hybrid', visualStyle: '', language: 'Traditional Chinese', audience: 'General' });
            const [reportStyle, setReportStyle] = useState('Professional');
            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);

            useEffect(() => { localStorage.setItem('ANYGEM_USER_ID', currentSessionId); loadHistoryList(); if(messages.length===0) setMessages([{ id: 'welcome', role: 'ai', text: "ğŸ‘‹ **æ­¡è¿ä½¿ç”¨ anyGem Next**\n\næˆ‘æ˜¯æ‚¨çš„ AI æ™ºèƒ½åŠ©æ‰‹ã€‚è«‹é¸æ“‡ä¸Šæ–¹æ¨¡å¼ï¼ˆèŠå¤©ã€æœå°‹ã€ç ”å ±ã€ç°¡å ±ï¼‰é–‹å§‹ä½¿ç”¨ã€‚", timestamp: Date.now() }]); }, [currentSessionId]);
            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

            const loadHistoryList = async () => { const data = await fetchSessions(); if (data.sessions) setSessions(data.sessions); };
            const handleNewChat = () => { const newId = `UID_${Date.now()}`; setCurrentSessionId(newId); setMessages([]); setMode(AppMode.CHAT); };
            const loadSessionHandler = async (id) => { setCurrentSessionId(id); const data = await loadSessionApi(id); if(data.logs) setMessages(data.logs.map((l,i)=>({id:`${id}_${i}`, role:l.role, text:l.text, timestamp:Date.now()}))); };
            const deleteSessionHandler = (id) => { setSessions(prev => prev.filter(s => s.id !== id)); };

            const handleSend = async () => {
                if (!input.trim() && !activeFile) return;
                const userMsg = { id: Date.now().toString(), role: 'user', text: input, timestamp: Date.now(), meta: { fileName: activeFile?.name } };
                setMessages(prev => [...prev, userMsg]);
                setInput(''); setLoading(true);

                let fileData = undefined;
                if (activeFile) {
                    fileData = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(activeFile);
                    });
                }

                const payload = { message: userMsg.text, session_id: currentSessionId, mode: mode, file_data: fileData ? fileData.split(',')[1] : undefined, mime_type: activeFile?.type, options: { ...pptOptions, style: reportStyle } };
                setActiveFile(null);
                const response = await sendMessage(payload);
                setLoading(false);

                if (response.status === 'success') {
                    setMessages(prev => [...prev, { id: (Date.now() + 1).toString(), role: 'ai', text: response.reply || "å®Œæˆã€‚", timestamp: Date.now(), meta: { model: response.model, image: response.image, mime: response.mime } }]);
                    loadHistoryList();
                } else {
                    setMessages(prev => [...prev, { id: Date.now().toString(), role: 'system', text: `ğŸš¨ éŒ¯èª¤: ${response.error || "æœªçŸ¥éŒ¯èª¤"}`, timestamp: Date.now() }]);
                }
            };

            return (
                <div className="flex h-screen bg-slate-950 text-slate-200 font-sans overflow-hidden">
                    <div className={`fixed inset-0 bg-black/50 z-40 transition-opacity ${sidebarOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'} md:hidden`} onClick={() => setSidebarOpen(false)} />
                    
                    <Sidebar 
                        isOpen={sidebarOpen} 
                        sessions={sessions} 
                        currentSessionId={currentSessionId} 
                        onNewChat={handleNewChat} 
                        onSelectSession={loadSessionHandler} 
                        onDeleteSession={deleteSessionHandler}
                        isCollapsed={sidebarCollapsed}
                        toggleCollapse={() => setSidebarCollapsed(!sidebarCollapsed)}
                    />
                    
                    <div className="flex-1 flex flex-col h-full relative">
                        <header className="h-14 border-b border-slate-800 flex items-center px-4 justify-between bg-slate-900/50 backdrop-blur-sm z-10 transition-all">
                            <div className="flex items-center gap-3">
                                <button onClick={() => setSidebarOpen(!sidebarOpen)} className="md:hidden text-slate-400 hover:text-white"><i className="fas fa-bars"></i></button>
                                <div className="font-bold text-white tracking-wide">anyGem <span className="text-primary font-normal">Next</span></div>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="flex items-center bg-slate-800 rounded-lg p-1">{Object.values(AppMode).map((m) => <button key={m} onClick={() => setMode(m)} className={`px-3 py-1 rounded-md text-xs font-medium transition-all capitalize ${mode === m ? 'bg-primary text-white shadow' : 'text-slate-400 hover:text-slate-200'}`}>{m === 'chat' ? 'ğŸ’¬' : m === 'search' ? 'ğŸŒ' : m === 'report' ? 'ğŸ“' : m === 'presentation' ? 'ğŸ“Š' : 'ğŸ¨'} {m}</button>)}</div>
                                <button 
                                    onClick={() => setShowRightPanel(!showRightPanel)} 
                                    className={`hidden lg:flex p-2 rounded-full hover:bg-slate-800 transition-colors ${showRightPanel ? 'text-primary' : 'text-slate-400'}`}
                                    title={showRightPanel ? "éš±è—å·¥ä½œå€" : "é¡¯ç¤ºå·¥ä½œå€"}
                                >
                                    <i className="fas fa-columns"></i>
                                </button>
                            </div>
                        </header>
                        <div className="flex-1 flex overflow-hidden">
                            <div className="flex-1 flex flex-col relative transition-all duration-300">
                                <div className="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth"><div className="max-w-3xl mx-auto">{messages.map((msg) => <MessageBubble key={msg.id} message={msg} />)}{loading && <div className="flex justify-start w-full mb-6 animate-pulse"><div className="bg-slate-800 rounded-2xl rounded-tl-sm p-4 text-slate-400 text-sm flex items-center gap-2"><i className="fas fa-circle-notch fa-spin text-primary"></i>è™•ç†ä¸­...</div></div>}<div ref={messagesEndRef} /></div></div>
                                <div className="p-4 border-t border-slate-800 bg-slate-900/80 backdrop-blur-md">
                                    <div className="max-w-3xl mx-auto relative">
                                        {activeFile && <div className="absolute -top-12 left-0 bg-slate-800 text-slate-300 text-xs px-3 py-2 rounded-lg border border-slate-700 flex items-center gap-2 shadow-lg"><i className="fas fa-file"></i> {activeFile.name}<button onClick={() => setActiveFile(null)} className="hover:text-red-400"><i className="fas fa-times"></i></button></div>}
                                        <div className="flex items-end gap-2 bg-slate-800/50 border border-slate-700 rounded-xl p-2 focus-within:border-primary/50 transition-all">
                                            <button onClick={() => fileInputRef.current?.click()} className="p-3 text-slate-400 hover:text-white transition-colors"><i className="fas fa-paperclip"></i></button>
                                            <input type="file" ref={fileInputRef} className="hidden" onChange={(e) => setActiveFile(e.target.files[0])} />
                                            <textarea value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } }} placeholder={`åœ¨ ${mode} æ¨¡å¼ä¸‹è¼¸å…¥è¨Šæ¯...`} className="flex-1 bg-transparent border-none outline-none text-slate-200 text-sm resize-none py-3" rows={1} style={{ minHeight: '44px' }} />
                                            <button onClick={handleSend} disabled={loading || (!input.trim() && !activeFile)} className="p-3 bg-primary hover:bg-emerald-600 text-white rounded-lg disabled:opacity-50 transition-all"><i className="fas fa-paper-plane"></i></button>
                                        </div>
                                        <div className="text-center mt-2 text-[10px] text-slate-600">AI å¶çˆ¾æœƒçŠ¯éŒ¯ï¼Œè«‹æ ¸æŸ¥é‡è¦è³‡è¨Šã€‚</div>
                                    </div>
                                </div>
                            </div>
                            <Canvas isOpen={showRightPanel} mode={mode} pptOptions={pptOptions} setPptOptions={setPptOptions} reportStyle={reportStyle} setReportStyle={setReportStyle} activeFile={activeFile} />
                        </div>
                    </div>
                </div>
            );
        };

        // 4. MOUNT APP
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
